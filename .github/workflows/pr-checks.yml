# SPDX-FileCopyrightText: Â© 2025 Eashwar Ranganathan <eashwar@eashwar.com>
# SPDX-License-Identifier: MIT

name: PR Checks
on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
permissions: {}

concurrency:
  group: ${{ github.workflow_ref }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  actions:
    if: github.event.pull_request.draft == false
    name: Check Actions
    runs-on: ubuntu-latest
    timeout-minutes: 1
    permissions:
      contents: read # Required to check out the repo
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
      - run: uv sync --locked --only-group github
      - run: uv run --no-sync python .github/scripts/actions-hashes.py check
  lint:
    needs: [actions]
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: read # Required to check out the repo
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
      - run: uv sync --locked --only-group lint
      - id: determine-python-version
        name: Determine python version
        shell: bash
        run: echo "python-version=$(uv run --no-sync python -V | cut -d' ' -f2)" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|${{ steps.determine-python-version.outputs.python-version }}|${{ hashFiles('.pre-commit-config.yaml') }}
      - run: uv run --no-sync pre-commit run --show-diff-on-failure --color=always --all-files
  tests:
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10" # tag::MIN_PYTHON
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
          - 3.14t
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            os-name: Ubuntu
          - os: macos-latest
            os-name: MacOS
    name: Tests / ${{ matrix.os-name }} / ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 5
    permissions:
      contents: read # Required to check out the repo
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          python-version: ${{ matrix.python-version }}
      - run: uv sync --locked --no-default-groups --group test
      - run: uv run --no-sync pytest tests
  tests-green:
    if: always()
    needs: [tests]
    runs-on: ubuntu-latest
    timeout-minutes: 1
    permissions: {}
    steps:
      - uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          jobs: ${{ toJSON(needs) }}
